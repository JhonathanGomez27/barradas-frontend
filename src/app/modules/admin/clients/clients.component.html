<div class="absolute inset-0 flex min-w-0 flex-col overflow-y-auto bg-barradas-50" cdkScrollable>

    <!-- Header -->
    <div class="bg-gradient-to-r from-barradas-900 to-barradas-700 shadow-lg">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between px-4 py-6 sm:px-10 sm:py-8">
            <div class="min-w-0 flex-1">
                <!-- Breadcrumbs -->
                <div class="mb-2">
                    <div class="flex items-center font-medium text-barradas-300">
                        <mat-icon class="mr-2 text-white">people</mat-icon>
                        <span class="text-white">Gestión de Clientes</span>
                    </div>
                </div>
                <!-- Title -->
                <div class="flex items-center">
                    <h2 class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-white tracking-tight">
                        Clientes
                    </h2>
                    <span class="ml-4 px-3 py-1 bg-white/20 rounded-full text-sm font-medium text-white">
                        {{ totalClients }} total
                    </span>
                </div>
            </div>
            <!-- Actions -->
            <div class="mt-4 sm:mt-0 sm:ml-4 flex flex-col sm:flex-row gap-2 sm:gap-3">
                <button mat-raised-button
                        *ngIf="hasPermission('invitations:create:all:post:invitations')"
                        class="bg-white text-barradas-900 hover:bg-barradas-50 shadow-md hover:shadow-lg transition-all duration-300 w-full sm:w-auto"
                        (click)="openInviteDialog()">
                    <mat-icon class="mr-2">person_add</mat-icon>
                    <span>Invitar Cliente</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main -->
    <div class="flex-auto p-4 sm:p-6 lg:p-8">
        <!-- Filtros -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-8 transition-all duration-300 hover:shadow-xl">
            <div class="bg-gradient-to-r from-barradas-50 to-white px-4 py-3 sm:px-6 sm:py-4 border-b border-gray-200">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center">
                        <div class="bg-barradas-300/20 p-2 rounded-lg mr-3 flex-shrink-0">
                            <mat-icon class="text-barradas-700">filter_alt</mat-icon>
                        </div>
                        <h3 class="font-semibold text-gray-800 text-base md:text-lg">Filtros de Búsqueda</h3>
                    </div>
                </div>
            </div>

            <div class="p-4 sm:p-5">
                <div class="grid grid-cols-1 xl:grid-cols-[minmax(0,1.3fr)_auto] gap-3 mb-4 items-start">
                    <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full fuse-mat-dense">
                        <mat-label>Buscar por nombre, email o teléfono</mat-label>
                        <input matInput
                               [(ngModel)]="searchFilter"
                               placeholder="Escribe para buscar..."
                               (keyup.enter)="applySearchFilter()">
                        <mat-icon matPrefix class="text-gray-400 mr-2">search</mat-icon>
                        <button mat-icon-button matSuffix *ngIf="searchFilter" (click)="clearSearchFilter()" matTooltip="Limpiar búsqueda">
                            <mat-icon>close</mat-icon>
                        </button>
                    </mat-form-field>

                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                        <button mat-stroked-button
                                color="warn"
                                class="w-full"
                                (click)="clearDateFilter()"
                                matTooltip="Limpiar todos los filtros">
                            <mat-icon>clear_all</mat-icon>
                            <span class="hidden sm:inline ml-1">Limpiar</span>
                        </button>
                        <button mat-stroked-button
                                class="w-full"
                                (click)="loadClients()"
                                matTooltip="Actualizar lista">
                            <mat-icon>refresh</mat-icon>
                            <span class="hidden sm:inline ml-1">Refrescar</span>
                        </button>
                        <button mat-raised-button
                                color="primary"
                                class="w-full col-span-2 sm:col-span-1"
                                (click)="applyDateFilter()">
                            <mat-icon class="mr-1">search</mat-icon>
                            Aplicar
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 items-start">
                    <!-- Filtro de Estado -->
                    <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full fuse-mat-dense">
                        <mat-label>Estado</mat-label>
                        <mat-select [(ngModel)]="statusFilter" (selectionChange)="onFilterChange()">
                            <mat-option value="">
                                <span class="flex items-center">
                                    <mat-icon svgIcon="mat_outline:all_inclusive" class="mr-2 text-gray-400 scale-75"></mat-icon>
                                    Todos los estados
                                </span>
                            </mat-option>
                            <mat-option *ngFor="let status of statusOptions" [value]="status">
                                <span class="flex items-center">
                                    <mat-icon class="mr-2 scale-75" [ngClass]="{
                                        'text-green-500': status === 'COMPLETED',
                                        'text-blue-500': status === 'INVITED',
                                        'text-yellow-500': status === 'IN_PROGRESS',
                                        'text-violet-500': status === 'NO_CONTRACT_SENDED',
                                        'text-orange-500': status === 'CONTRACT_SENDED',
                                        'text-gray-500': status === 'CREATED'
                                    }" svgIcon="mat_outline:circle"></mat-icon>
                                    {{ statusMapper[status] }}
                                </span>
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix class="text-gray-400">filter_list</mat-icon>
                    </mat-form-field>

                    <!-- Filtro de Estado de Crédito -->
                    <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full fuse-mat-dense">
                        <mat-label>Estado de Crédito</mat-label>
                        <mat-select [(ngModel)]="statusCreditFilter" (selectionChange)="onFilterChange()">
                            <mat-option value="">
                                <span class="flex items-center">
                                    <mat-icon svgIcon="mat_outline:all_inclusive" class="mr-2 text-gray-400 scale-75"></mat-icon>
                                    Todos los estados
                                </span>
                            </mat-option>
                            <mat-option *ngFor="let status of statusCreditOptions" [value]="status.value">
                                <span class="flex items-center">
                                    <mat-icon svgIcon="mat_outline:credit_card" class="mr-2 scale-75" [ngClass]="{
                                        'text-green-500': status.value === 'CLOSED',
                                        'text-blue-500': status.value === 'ACTIVE',
                                        'text-yellow-500': status.value === 'PENDING',
                                        'text-red-500': status.value === 'DEFAULTED',
                                        'text-gray-500': status.value === 'CANCELLED'
                                    }"></mat-icon>
                                    {{ status.viewValue }}
                                </span>
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix class="text-gray-400">account_balance_wallet</mat-icon>
                    </mat-form-field>

                    <!-- Filtro de Tienda -->
                    @if(hasPermission('stores:read:store:get:stores.all')) {

                        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full fuse-mat-dense">
                            <mat-label>Tienda</mat-label>
                            <mat-select [(ngModel)]="storeFilter" (selectionChange)="onFilterChange()">
                                <mat-option>
                                    <ngx-mat-select-search
                                        [formControl]="storeFilterCtrl"
                                        placeholderLabel="Buscar tienda..."
                                        noEntriesFoundLabel="No se encontraron tiendas">
                                    </ngx-mat-select-search>
                                </mat-option>
                                <mat-option value="">
                                    <span class="flex items-center">
                                        <mat-icon svgIcon="mat_outline:all_inclusive" class="mr-2 text-gray-400 scale-75"></mat-icon>
                                        Todas las tiendas
                                    </span>
                                </mat-option>
                                <mat-option *ngFor="let store of filteredStores | async" [value]="store.id">
                                    <span class="flex items-center">
                                        <mat-icon svgIcon="mat_outline:store" class="mr-2 text-barradas-500 scale-75"></mat-icon>
                                        {{ store.name }}
                                    </span>
                                </mat-option>
                            </mat-select>
                            <mat-icon matPrefix class="text-gray-400">storefront</mat-icon>
                        </mat-form-field>
                    }
                    <!-- Rango de Fechas -->
                    <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full fuse-mat-dense sm:col-span-2 xl:col-span-1">
                        <mat-label>Rango de Fechas</mat-label>
                        <mat-date-range-input [rangePicker]="picker" [max]="today">
                            <input matStartDate placeholder="Fecha inicio" [(ngModel)]="start" name="start">
                            <input matEndDate placeholder="Fecha fin" [(ngModel)]="end" name="end">
                        </mat-date-range-input>
                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-date-range-picker #picker></mat-date-range-picker>
                        <mat-icon matPrefix class="text-gray-400">date_range</mat-icon>
                    </mat-form-field>
                </div>
            </div>
        </div>

        <!-- Tabla de Clientes -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden transition-all duration-300 hover:shadow-xl"  *ngIf="clients.length > 0; else noClientsTemplate">
            <div class="bg-gradient-to-r from-barradas-50 to-white px-4 py-3 sm:px-5 sm:py-4 border-b border-gray-200">
                <div class="flex items-center justify-between flex-wrap gap-2">
                    <div class="flex items-center">
                        <div class="bg-barradas-300/20 p-2 rounded-lg mr-3 flex-shrink-0">
                            <mat-icon class="text-barradas-700">people</mat-icon>
                        </div>
                        <h3 class="font-semibold text-gray-800 text-base md:text-lg">Lista de Clientes</h3>
                    </div>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs md:text-sm font-medium bg-barradas-300/20 text-barradas-900">
                        <mat-icon class="mr-1 text-base w-4 h-4">list</mat-icon>
                        {{ clients.length }} clientes
                    </span>
                </div>
            </div>

            <!-- Vista de tabla para desktop -->
            <div class="hidden md:block overflow-x-auto fuse-mat-dense">
                <table mat-table [dataSource]="clients" class="min-w-full text-sm">

                    <!-- Email Column -->
                    <ng-container matColumnDef="email">
                        <th mat-header-cell *matHeaderCellDef class="text-left px-3 py-2.5 font-semibold text-gray-700 bg-barradas-50">
                            <div class="flex items-center">
                                <mat-icon class="mr-2 text-gray-400 text-[18px] w-[18px] h-[18px]">email</mat-icon>
                                Email
                            </div>
                        </th>
                        <td mat-cell *matCellDef="let client" class="px-3 py-2.5 text-gray-800">
                            <div class="flex items-center">
                                <div class="w-7 h-7 bg-gradient-to-br from-barradas-300 to-barradas-500 rounded-full flex items-center justify-center text-barradas-900 font-semibold text-xs mr-2 flex-shrink-0">
                                    {{ client.email.charAt(0).toUpperCase() }}
                                </div>
                                <span class="truncate">{{ client.email }}</span>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Name Column -->
                    <ng-container matColumnDef="name">
                        <th mat-header-cell *matHeaderCellDef class="text-left px-3 py-2.5 font-semibold text-gray-700 bg-barradas-50">
                            <div class="flex items-center">
                                <mat-icon class="mr-2 text-gray-400 text-[18px] w-[18px] h-[18px]">person</mat-icon>
                                Nombre
                            </div>
                        </th>
                        <td mat-cell *matCellDef="let client" class="px-3 py-2.5 text-gray-800 font-medium">
                            {{ client.firstName | titlecase }} {{ client.lastName | titlecase }}
                        </td>
                    </ng-container>

                    <!-- Phone Column -->
                    <ng-container matColumnDef="phone">
                        <th mat-header-cell *matHeaderCellDef class="text-left px-3 py-2.5 font-semibold text-gray-700 bg-barradas-50">
                            <div class="flex items-center">
                                <mat-icon class="mr-2 text-gray-400 text-[18px] w-[18px] h-[18px]">phone</mat-icon>
                                Teléfono
                            </div>
                        </th>
                        <td mat-cell *matCellDef="let client" class="px-3 py-2.5 text-gray-600">
                            <span class="flex items-center">
                                <mat-icon class="mr-1 text-gray-400 text-[14px] w-[14px] h-[14px]">call</mat-icon>
                                {{ client.phone || 'N/A' }}
                            </span>
                        </td>
                    </ng-container>

                    <!-- Status Column -->
                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef class="text-left px-3 py-2.5 font-semibold text-gray-700 bg-barradas-50">
                            <div class="flex items-center">
                                <mat-icon class="mr-2 text-gray-400 text-[18px] w-[18px] h-[18px]">info</mat-icon>
                                Estado
                            </div>
                        </th>
                        <td mat-cell *matCellDef="let client" class="px-3 py-2.5">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold transition-all duration-200"
                                  [ngClass]="{
                                    'bg-green-100 text-green-800 hover:bg-green-200': client.status === 'COMPLETED',
                                    'bg-blue-100 text-blue-800 hover:bg-blue-200': client.status === 'INVITED',
                                    'bg-yellow-100 text-yellow-800 hover:bg-yellow-200': client.status === 'IN_PROGRESS',
                                    'bg-violet-100 text-violet-800 hover:bg-violet-200': client.status === 'NO_CONTRACT_SENDED',
                                    'bg-orange-100 text-orange-800 hover:bg-orange-200': client.status === 'CONTRACT_SENDED',
                                    'bg-gray-100 text-gray-800 hover:bg-gray-200': client.status === 'CREATED'
                                  }">
                                {{ statusMapper[client.status] || client.status }}
                            </span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="store">
                        <th mat-header-cell *matHeaderCellDef class="text-left px-3 py-2.5 font-semibold text-gray-700 bg-barradas-50">
                            <div class="flex items-center">
                                <mat-icon class="mr-2 text-gray-400 text-[18px] w-[18px] h-[18px]">storefront</mat-icon>
                                Tienda
                            </div>
                        </th>
                        <td mat-cell *matCellDef="let client" class="px-3 py-2.5 text-gray-600">
                            <div class="flex items-center">
                                <mat-icon class="mr-1 text-gray-400 text-[14px] w-[14px] h-[14px]">store</mat-icon>
                                <span>
                                    {{ client.store?.name || 'N/A' }}
                                </span>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Created At Column -->
                    <ng-container matColumnDef="created_at">
                        <th mat-header-cell *matHeaderCellDef class="text-left px-3 py-2.5 font-semibold text-gray-700 bg-barradas-50">
                            <div class="flex items-center">
                                <mat-icon class="mr-2 text-gray-400 text-[18px] w-[18px] h-[18px]">schedule</mat-icon>
                                Creado
                            </div>
                        </th>
                        <td mat-cell *matCellDef="let client" class="px-3 py-2.5 text-gray-600 text-xs whitespace-nowrap">
                            {{ client.createdAt | date:'dd/MM/yyyy HH:mm' }}
                        </td>
                    </ng-container>

                    <!-- Updated At Column -->
                    <ng-container matColumnDef="updated_at">
                        <th mat-header-cell *matHeaderCellDef class="text-left px-3 py-2.5 font-semibold text-gray-700 bg-barradas-50">
                            <div class="flex items-center">
                                <mat-icon class="mr-2 text-gray-400 text-[18px] w-[18px] h-[18px]">update</mat-icon>
                                Credito
                            </div>
                        </th>
                        <td mat-cell *matCellDef="let client" class="px-3 py-2.5 text-gray-600 text-xs">
                            <div *ngIf="client.credits.length > 0; else noCredit" class="flex flex-wrap items-center gap-1.5">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold transition-all duration-200 w-fit"
                                [ngClass]="{
                                    'bg-green-100 text-green-800 hover:bg-green-200': client.credits[0].status === 'CLOSED',
                                    'bg-blue-100 text-blue-800 hover:bg-blue-200': client.credits[0].status === 'PENDING',
                                    'bg-yellow-100 text-yellow-800 hover:bg-yellow-200': client.credits[0].status === 'ACTIVE',
                                    'bg-red-100 text-red-800 hover:bg-red-200': client.credits[0].status === 'DEFAULTED',
                                    'bg-orange-100 text-orange-800 hover:bg-orange-200': client.credits[0].status === 'CANCELLED'
                                }">
                                    {{ statusCreditsMapper[client.credits[0].status] || client.credits[0].status }}
                                </span>
                                <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[11px] text-gray-600">
                                    <mat-icon class="mr-1 text-gray-400 text-[12px] w-[12px] h-[12px]">event</mat-icon>
                                    {{ weekDaysMapper[client.credits[0].repaymentDay] || client.credits[0].repaymentDay }}
                                </span>
                            </div>
                            <ng-template #noCredit>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold transition-all duration-200 bg-gray-100 text-gray-800 hover:bg-gray-200">Pendiente de credito</span>
                            </ng-template>
                        </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef class="text-center px-3 py-2.5 font-semibold text-gray-700 bg-barradas-50">
                            <mat-icon class="text-gray-400 text-[18px] w-[18px] h-[18px]">settings</mat-icon>
                        </th>
                        <td mat-cell *matCellDef="let client" class="px-3 py-2.5 text-center">
                            <div class="flex items-center justify-center gap-1">
                                <button mat-icon-button
                                        *ngIf="client.status === 'INVITED' && hasPermission('invitations:create:all:post:invitations')"
                                        color="primary"
                                        (click)="copyProfileLink(client, $event)"
                                        [disabled]="!client.links || client.links.length === 0"
                                        matTooltip="Copiar enlace"
                                        class="hover:bg-barradas-300/20 transition-colors !w-8 !h-8">
                                    <mat-icon>content_copy</mat-icon>
                                </button>
                                <button mat-icon-button
                                        *ngIf="hasPermission('users:delete:all:delete:users.id')"
                                        color="warn"
                                        (click)="confirmDeleteClient(client.id, $event)"
                                        matTooltip="Eliminar cliente"
                                        class="hover:bg-red-50 transition-colors !w-8 !h-8">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </div>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns" class="sticky top-0 z-10"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                        class="hover:bg-barradas-50 cursor-pointer transition-colors duration-150 border-b border-gray-100"
                        (click)="onClick(row)">
                    </tr>
                </table>
            </div>

            <!-- Vista de tarjetas para móviles -->
            <div class="md:hidden divide-y divide-gray-200">
                <div *ngFor="let client of clients"
                     class="p-4 hover:bg-barradas-50 transition-colors cursor-pointer"
                     (click)="onClick(client)">
                    <div class="flex items-start justify-between mb-2.5">
                        <div class="flex items-center flex-1 min-w-0">
                            <div class="w-9 h-9 bg-gradient-to-br from-barradas-300 to-barradas-500 rounded-full flex items-center justify-center text-barradas-900 font-semibold mr-3 flex-shrink-0">
                                {{ client.email.charAt(0).toUpperCase() }}
                            </div>
                            <div class="min-w-0 flex-1">
                                <p class="font-semibold text-gray-900 truncate">{{ client.firstName | titlecase }} {{ client.lastName | titlecase }}</p>
                                <p class="text-sm text-gray-500 truncate">{{ client.email }}</p>
                            </div>
                        </div>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold ml-2 transition-all duration-200"
                              [ngClass]="{
                                'bg-green-100 text-green-800 hover:bg-green-200': client.status === 'COMPLETED',
                                'bg-blue-100 text-blue-800 hover:bg-blue-200': client.status === 'INVITED',
                                'bg-yellow-100 text-yellow-800 hover:bg-yellow-200': client.status === 'IN_PROGRESS',
                                'bg-violet-100 text-violet-800 hover:bg-violet-200': client.status === 'NO_CONTRACT_SENDED',
                                'bg-orange-100 text-orange-800 hover:bg-orange-200': client.status === 'CONTRACT_SENDED',
                                'bg-gray-100 text-gray-800 hover:bg-gray-200': client.status === 'CREATED'
                              }">
                            {{ statusMapper[client.status] }}
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600 mb-2.5">
                        <div class="flex items-center">
                            <mat-icon class="mr-1 text-gray-400 text-base w-4 h-4">phone</mat-icon>
                            {{ client.phone || 'N/A' }}
                        </div>
                        <div class="flex items-center">
                            <mat-icon class="mr-1 text-gray-400 text-base w-4 h-4">schedule</mat-icon>
                            {{ client.createdAt | date:'dd/MM/yyyy' }}
                        </div>
                    </div>
                    <div class="flex justify-end gap-1.5" (click)="$event.stopPropagation()">
                        <button mat-icon-button
                                *ngIf="client.status === 'INVITED' && hasPermission('invitations:create:all:post:invitations')"
                                color="primary"
                                (click)="copyProfileLink(client, $event)"
                                [disabled]="!client.links || client.links.length === 0"
                                matTooltip="Copiar enlace"
                                class="transition-colors duration-200">
                            <mat-icon>content_copy</mat-icon>
                        </button>
                        <button mat-icon-button
                                *ngIf="hasPermission('users:delete:all:delete:users.id')"
                                color="warn"
                                (click)="confirmDeleteClient(client.id, $event)"
                                matTooltip="Eliminar"
                                class="transition-colors duration-200">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Paginador -->
            <div class="border-t border-gray-200 bg-barradas-50 px-4 py-2">
                <mat-paginator
                    [length]="totalClients"
                    [pageSize]="pageSize"
                    [pageIndex]="page - 1"
                    [pageSizeOptions]="[5, 10, 20]"
                    (page)="onPageMatChange($event)">
                </mat-paginator>
            </div>
        </div>

        <!-- Mensaje cuando no hay clientes -->
        <ng-template #noClientsTemplate>
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden p-10 sm:p-12 text-center">
                <div class="flex flex-col items-center">
                    <div class="bg-gray-100 p-6 rounded-full mb-4">
                        <mat-icon class="text-gray-400 text-6xl">people_outline</mat-icon>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">No hay clientes para mostrar</h3>
                    <p class="text-gray-500 mb-6">Comienza invitando a tu primer cliente</p>
                    <button mat-raised-button color="primary" (click)="openInviteDialog()" *ngIf="hasPermission('invitations:create:all:post:invitations')" class="transition-all duration-200">
                        <mat-icon class="mr-2">person_add</mat-icon>
                        Invitar Cliente
                    </button>
                </div>
            </div>
        </ng-template>
    </div>
</div>
